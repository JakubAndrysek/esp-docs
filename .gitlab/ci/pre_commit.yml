.check_pre_commit_template:
  stage: check
  image: $ESP_DOCS_ENV_IMAGE
  extends:
    - .before_script_minimal
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - pip install pre-commit
    # Fetch target branch latest commit
    - git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME --depth=1
    # Fetch source branch latest commit
    - git fetch origin $CI_COMMIT_REF_NAME --depth=1

    - |
      echo "Target branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
      echo "Source branch: $CI_COMMIT_REF_NAME"

      MODIFIED_FILES=$(git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME..origin/$CI_COMMIT_REF_NAME)
      echo "Modified files to check:"
      echo "$MODIFIED_FILES"

      if [ -n "$MODIFIED_FILES" ]; then
          CI=true pre-commit run --files $MODIFIED_FILES
      else
          echo "No modified files to check."
      fi


check_pre_commit:
  extends:
    - .check_pre_commit_template


check_setup:
  stage: check
  image: $ESP_DOCS_ENV_IMAGE
  extends:
    - .before_script_minimal
  script:
    - pip install .


check_python_style:
  stage: check
  image: $ESP_DOCS_ENV_IMAGE
  extends:
    - .before_script_minimal
  script:
    - pip install flake8
    - python -m flake8 --config=$ESP_DOCS_PATH/.flake8 $ESP_DOCS_PATH
